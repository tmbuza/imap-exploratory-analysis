# Exploration of processded data

## Import data
```{r}
library(tidyverse)
library(phyloseq)
# library(metagMisc)
library(microbiome)
# library(microViz)
if (!require("microbiomeMarker")) {BiocManager::install("microbiomeMarker")}
library(microbiomeMarker)

# QIIME2
# load("~/Dropbox/MICROBIOME/imap-data-processing/data/qiime2/qiime2_phyloseq_objects.rda", verbose = TRUE)
# composite <- read_csv("~/Dropbox/MICROBIOME/imap-data-processing/data/qiime2/qiime2_composite.csv", show_col_types = FALSE)

# Mothur
# load("~/Dropbox/MICROBIOME/imap-data-processing/data/mothur/mothur_phyloseq_objects.rda", verbose = TRUE)
# composite <- read_csv("~/Dropbox/MICROBIOME/imap-data-processing/data/mothur/mothur_composite.csv", show_col_types = FALSE)

# External data
load("~/Dropbox/MICROBIOME/imap-data-processing/data/external_phyloseq_objects.rda", verbose = TRUE)
# composite <- read_csv("~/Dropbox/MICROBIOME/imap-data-processing/data/mothur/mothur_composite.csv", show_col_types = FALSE)

ps <- ps_rel
ps
```

## Plot basic phyloseq cladogram
```{r fig.height=15, fig.width=10}
library(phyloseq)
# plot(ps_tree)
```


## Plot lefse LDA heatmap
```{r}
library(microbiomeMarker)
data(kostic_crc)

ps <- kostic_crc
```




```{r message=FALSE, warning=FALSE}
phy <- phyloseq::subset_taxa(
    ps,
    Phylum %in% c("Firmicutes")
)
mm_lefse <- run_lefse(
    phy,
    wilcoxon_cutoff = 0.01,
    group = "DIAGNOSIS",
    kw_cutoff = 0.01,
    multigrp_strat = TRUE,
    lda_cutoff = 1
)
plot_heatmap(mm_lefse, group = "DIAGNOSIS")

```


## Plot lefse LDA cladogram
```{r message=FALSE, warning=FALSE}
data(kostic_crc)
kostic_crc_small <- phyloseq::subset_taxa(
    kostic_crc,
    Phylum %in% c("Firmicutes")
)
mm_lefse <- run_lefse(
    kostic_crc_small,
    wilcoxon_cutoff = 0.01,
    group = "DIAGNOSIS",
    kw_cutoff = 0.01,
    multigrp_strat = TRUE,
    lda_cutoff = 4
)
plot_cladogram(mm_lefse, color = c("darkgreen", "red"))


```


## Plot ggtree cladogram
```{r fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
library(ggtree)

ggtree(
  ps_tree,
  mapping = NULL,
  layout = "circular",
  open.angle = 0,
  mrsd = NULL,
  as.Date = FALSE,
  yscale = "none",
  yscale_mapping = NULL,
  ladderize = TRUE,
  right = FALSE,
  branch.length = "branch.length",
  root.position = 0,
  xlim = NULL
)


```

## Overal number of samples
```{r}
nsamples(ps)
```


## Overal number of taxa
```{r}
ntaxa(ps)
```


```{r}
#---------------------------------
library(phyloseq)
library(dplyr)
library(ggplot2)
library(microbiome)
library(microbiomeMarker)
#---------------------------------

# Stacked Barplots
library(ggplot2)
data(dietswap, package = "microbiome")




#---------------------------------
# Heatmap
htmp <- dietswap %>%
  ps_mutate(nationality = as.character(nationality)) %>%
  tax_transform("log2", add = 1, chain = TRUE) %>%
  comp_heatmap(
    taxa = tax_top(dietswap, n = 30), grid_col = NA, name = "Log2p",
    taxon_renamer = function(x) stringr::str_remove(x, " [ae]t rel."),
    colors = heat_palette(palette = viridis::turbo(11)),
    row_names_side = "left", row_dend_side = "right", sample_side = "bottom",
    sample_anno = sampleAnnotation(
      Nationality = anno_sample_cat(
        var = "nationality", col = c(AAM = "red", AFR = "green"),
        box_col = NA, legend_title = "Nationality", size = grid::unit(4, "mm")
      )
    )
  )

ComplexHeatmap::draw(
  object = htmp, annotation_legend_list = attr(htmp, "AnnoLegends"),
  merge_legends = TRUE
)

# Ordination
ord1 <- dietswap %>%
  tax_filter(min_prevalence = 0.1, tax_level = "Genus") %>%
  tax_agg("Family") %>%
  tax_transform("clr") %>%
  ord_calc()

ord2 <- ord1 %>% 
  ord_plot(
    plot_taxa = 1:6, colour = "bmi_group", size = 1.5,
    tax_vec_length = 0.325,
    tax_lab_style = tax_lab_style(max_angle = 90, aspect_ratio = 0.5),
    auto_caption = 8) +
   stat_ellipse(aes(linetype = bmi_group, colour = bmi_group), linewidth = 0.3) +
   scale_colour_brewer(palette = "Set1") +
   theme(legend.position = "bottom") +
   coord_fixed(ratio = 0.5, clip = "off") 

```